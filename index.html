<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš€ KMH Quantum Flow v5.0 â€” Painel Cognitivo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-900 text-gray-100 flex flex-col items-center min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-4 text-center">ğŸš€ KMH Quantum Flow v5.0 â€” Painel Cognitivo</h1>
  <p class="text-sm text-gray-400 mb-6 text-center">
    Painel com prediÃ§Ã£o, insights automÃ¡ticos, grÃ¡fico histÃ³rico e exportaÃ§Ã£o.
  </p>

  <div class="flex flex-wrap justify-center gap-6 w-full max-w-5xl">
    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ•’ LatÃªncia MÃ©dia (Ãºltimo)</h2>
      <p id="avg_latency" class="text-3xl mt-2">Sem dados</p>
      <p id="trend_latency" class="text-sm text-gray-400">TendÃªncia: â€”</p>
    </div>

    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ“Š Taxa de Sucesso (Ãºltimo)</h2>
      <p id="merge_success" class="text-3xl mt-2">Sem dados</p>
      <p id="trend_success" class="text-sm text-gray-400">TendÃªncia: â€”</p>
    </div>

    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ”® PrevisÃ£o (prÃ³xima)</h2>
      <p id="prediction" class="text-xl mt-2 text-blue-300">Sem prediÃ§Ã£o</p>
      <button id="refresh" class="mt-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded">Atualizar</button>
    </div>
  </div>

  <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mt-8 w-full max-w-5xl">
    <canvas id="latencyChart" height="100"></canvas>
  </div>

  <footer class="mt-8 text-sm opacity-60 text-center">
    KMH Cognitive Quantum Flow v5.0 â€” KMH Index Cognitivo
  </footer>

  <script>
    // ==============================
    // CONFIGURAÃ‡ÃƒO DO SUPABASE
    // ==============================
    const SUPABASE_URL = "https://nfvbrdjbiolpclskwqzj.supabase.co/rest/v1";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mdmJyZGpiaW9scGNsc2t3cXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MTgxNDUsImV4cCI6MjA3ODI5NDE0NX0.BfUIC-f_WFZj9OfY6yYSRdueD5q8qSv4pRIVNykeJVE";

    const HEADERS = {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
    };

    // ==============================
    // FUNÃ‡ÃƒO PRINCIPAL
    // ==============================
    async function loadMetrics() {
      try {
        const response = await fetch(`${SUPABASE_URL}/tuning_logs?select=*`, {
          headers: HEADERS,
        });

        if (!response.ok) throw new Error("Erro na resposta do Supabase");

        const data = await response.json();
        if (!data.length) throw new Error("Sem dados");

        const last = data[data.length - 1];
        const avgLatency = last.avg_latency?.toFixed(2) || "â€”";
        const successRate = last.merge_success_rate
          ? (last.merge_success_rate * 100).toFixed(1) + "%"
          : "â€”";

        document.getElementById("avg_latency").innerText = `${avgLatency}s`;
        document.getElementById("merge_success").innerText = successRate;

        // ===========================
        // TREND & PREDIÃ‡ÃƒO
        // ===========================
        const latencyTrend = trendDirection(data.map(d => d.avg_latency));
        const successTrend = trendDirection(data.map(d => d.merge_success_rate));

        document.getElementById("trend_latency").innerText =
          `TendÃªncia: ${latencyTrend}`;
        document.getElementById("trend_success").innerText =
          `TendÃªncia: ${successTrend}`;

        const prediction = predictNext(data.map(d => d.avg_latency));
        document.getElementById("prediction").innerText =
          `PrÃ³x. LatÃªncia: ${prediction.toFixed(2)}s`;

        drawChart(data);
      } catch (error) {
        console.error(error);
        document.getElementById("avg_latency").innerText = "Erro ao conectar";
        document.getElementById("merge_success").innerText = "Erro ao conectar";
        document.getElementById("prediction").innerText = "Erro ao conectar";
      }
    }

    // ==============================
    // FUNÃ‡Ã•ES DE ANÃLISE
    // ==============================
    function trendDirection(values) {
      if (values.length < 2) return "â€”";
      const diff = values[values.length - 1] - values[0];
      return diff > 0 ? "â¬†ï¸ Alta" : diff < 0 ? "â¬‡ï¸ Queda" : "â¡ï¸ EstÃ¡vel";
    }

    function predictNext(values) {
      if (values.length < 2) return values[values.length - 1] || 0;
      const n = values.length;
      const x = Array.from({ length: n }, (_, i) => i + 1);
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = values.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((a, b, i) => a + b * values[i], 0);
      const sumX2 = x.reduce((a, b) => a + b * b, 0);
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      return slope * (n + 1) + intercept;
    }

    // ==============================
    // GRÃFICO
    // ==============================
    function drawChart(data) {
      const ctx = document.getElementById("latencyChart").getContext("2d");
      const timestamps = data.map(d =>
        new Date(d.timestamp).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })
      );
      const latencies = data.map(d => d.avg_latency);

      new Chart(ctx, {
        type: "line",
        data: {
          labels: timestamps,
          datasets: [
            {
              label: "LatÃªncia (s)",
              data: latencies,
              borderColor: "rgb(75,192,192)",
              backgroundColor: "rgba(75,192,192,0.2)",
              tension: 0.3,
              fill: true,
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true },
          },
          plugins: { legend: { display: true } },
        },
      });
    }

    // ==============================
    // EVENTOS
    // ==============================
    document.getElementById("refresh").addEventListener("click", loadMetrics);
    loadMetrics();
  </script>
</body>
</html>
