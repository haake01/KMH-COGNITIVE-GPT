<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš€ KMH Quantum Flow v6.1 â€” Painel Cognitivo Total</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css?v=6.1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-900 text-gray-100 flex flex-col items-center min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-2 text-center">ğŸš€ KMH Quantum Flow v6.1 â€” Painel Cognitivo Total</h1>
  <p class="text-sm text-gray-400 mb-6 text-center">Painel cognitivo com prediÃ§Ã£o, insights automÃ¡ticos e aprendizado autÃ´nomo.</p>

  <!-- DASHBOARD -->
  <div class="flex flex-wrap justify-center gap-6 w-full max-w-5xl">
    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ•’ LatÃªncia MÃ©dia</h2>
      <p id="avg_latency" class="text-3xl mt-2">â€”</p>
      <p id="trend_latency" class="text-sm text-gray-400">TendÃªncia: â€”</p>
    </div>

    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ“Š Taxa de Sucesso</h2>
      <p id="merge_success" class="text-3xl mt-2">â€”</p>
      <p id="trend_success" class="text-sm text-gray-400">TendÃªncia: â€”</p>
    </div>

    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ§­ KMH Index</h2>
      <p id="kmh_index" class="text-3xl mt-2 text-green-400">â€”</p>
      <p class="text-sm text-gray-400">Estabilidade Cognitiva</p>
    </div>
  </div>

  <!-- LINHA INFERIOR -->
  <div class="flex flex-wrap justify-center gap-6 mt-6 w-full max-w-5xl">
    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ”® PrevisÃ£o</h2>
      <p id="prediction" class="text-xl mt-2 text-blue-300">Sem prediÃ§Ã£o</p>
      <button id="refresh" class="mt-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded">Atualizar</button>
    </div>

    <div class="bg-gray-800 p-4 rounded-2xl w-72 shadow-lg text-center">
      <h2 class="text-lg font-semibold">ğŸ’¾ ExportaÃ§Ã£o</h2>
      <button id="exportCSV" class="mt-3 px-3 py-1 bg-green-600 hover:bg-green-700 rounded">Exportar CSV</button>
      <p class="text-xs mt-2 text-gray-400">Ãšltimo update: <span id="last_update">â€”</span></p>
    </div>
  </div>

  <!-- GRÃFICO -->
  <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mt-8 w-full max-w-5xl">
    <canvas id="latencyChart" height="100"></canvas>
  </div>

  <!-- INSIGHT -->
  <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mt-8 w-full max-w-5xl">
    <h2 class="text-lg font-semibold mb-2">ğŸ§  Insight AutomÃ¡tico</h2>
    <p id="insightText" class="text-gray-300 text-sm italic">Aguardando anÃ¡lise...</p>
  </div>

  <footer class="mt-8 text-sm opacity-60 text-center">
    KMH Quantum Flow v6.1 â€” Cognitive Engine â€¢ Powered by Klebber Haake Â©2025
  </footer>

  <script>
    // ==============================
    // CONFIGURAÃ‡ÃƒO DO SUPABASE
    // ==============================
    const SUPABASE_URL = "https://nfvbrdjbiolpclskwqzj.supabase.co/rest/v1";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mdmJyZGpiaW9scGNsc2t3cXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MTgxNDUsImV4cCI6MjA3ODI5NDE0NX0.BfUIC-f_WFZj9OfY6yYSRdueD5q8qSv4pRIVNykeJVE";
    const HEADERS = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` };
    const isGithub = location.hostname.includes("github.io"); // modo leitura pÃºblica

    // ==============================
    // FUNÃ‡ÃƒO PRINCIPAL
    // ==============================
    async function loadMetrics(force = false) {
      try {
        const response = await fetch(`${SUPABASE_URL}/tuning_logs?select=*`, {
          headers: { ...HEADERS, "Cache-Control": force ? "no-cache" : "max-age=0" },
        });

        const data = await response.json();
        if (!data.length) {
          if (!isGithub) await generateSimulatedData(); // simula apenas localmente
          return loadMetrics(true);
        }

        const last = data[data.length - 1];
        const avgLatency = last.avg_latency?.toFixed(2);
        const successRate = (last.merge_success_rate * 100).toFixed(1);
        const kmhIndex = ((1 / avgLatency) * (successRate / 100) * 100).toFixed(1);

        document.getElementById("avg_latency").innerText = `${avgLatency}s`;
        document.getElementById("merge_success").innerText = `${successRate}%`;
        document.getElementById("kmh_index").innerText = `${kmhIndex}%`;
        document.getElementById("last_update").innerText = new Date(last.timestamp).toLocaleTimeString("pt-BR");

        const latTrend = trendDirection(data.map(d => d.avg_latency));
        const sucTrend = trendDirection(data.map(d => d.merge_success_rate));
        const prediction = predictNext(data.map(d => d.avg_latency));

        document.getElementById("trend_latency").innerText = `TendÃªncia: ${latTrend}`;
        document.getElementById("trend_success").innerText = `TendÃªncia: ${sucTrend}`;
        document.getElementById("prediction").innerText = `PrÃ³x. LatÃªncia: ${prediction.toFixed(2)}s`;

        drawChart(data);
        generateInsight(latTrend, sucTrend, avgLatency, successRate, prediction, kmhIndex);
      } catch (err) {
        document.getElementById("insightText").innerText = "âš ï¸ Operando em modo de leitura cognitiva (sem gravaÃ§Ã£o).";
      }
    }

    // ==============================
    // TENDÃŠNCIA E PREDIÃ‡ÃƒO
    // ==============================
    function trendDirection(values) {
      if (values.length < 2) return "â€”";
      const diff = values.at(-1) - values[0];
      return diff > 0.01 ? "â¬†ï¸ Alta" : diff < -0.01 ? "â¬‡ï¸ Queda" : "â¡ï¸ EstÃ¡vel";
    }

    function predictNext(values) {
      if (values.length < 2) return values.at(-1);
      const n = values.length;
      const x = Array.from({ length: n }, (_, i) => i + 1);
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = values.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((a, b, i) => a + b * values[i], 0);
      const sumX2 = x.reduce((a, b) => a + b * b, 0);
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      return slope * (n + 1) + intercept;
    }

    // ==============================
    // INSIGHTS AUTOMÃTICOS
    // ==============================
    function generateInsight(latTrend, sucTrend, latency, success, prediction, kmhIndex) {
      let insight = "";
      if (latTrend.includes("â¬‡ï¸") && sucTrend.includes("â¬†ï¸"))
        insight = "âœ… Sistema em alta eficiÃªncia: latÃªncia caiu e sucesso aumentou.";
      else if (latTrend.includes("â¬†ï¸") && sucTrend.includes("â¬‡ï¸"))
        insight = "âš ï¸ Instabilidade detectada: latÃªncia subiu e sucesso caiu.";
      else
        insight = "â„¹ï¸ Sistema estÃ¡vel, sem variaÃ§Ãµes crÃ­ticas.";

      insight += ` KMH Index atual: ${kmhIndex}%. PrevisÃ£o de latÃªncia: ${prediction.toFixed(2)}s.`;
      document.getElementById("insightText").innerText = insight;
    }

    // ==============================
    // AUTO-GERAÃ‡ÃƒO DE DADOS (SIMULAÃ‡ÃƒO)
    // ==============================
    async function generateSimulatedData() {
      const newEntry = {
        avg_latency: +(Math.random() * (1.2 - 0.6) + 0.6).toFixed(2),
        merge_success_rate: +(Math.random() * (0.98 - 0.85) + 0.85).toFixed(2),
        timestamp: new Date().toISOString(),
      };

      if (isGithub) {
        console.log("ğŸŒ Modo pÃºblico: simulaÃ§Ã£o local apenas.", newEntry);
        return;
      }

      try {
        await fetch(`${SUPABASE_URL}/tuning_logs`, {
          method: "POST",
          headers: { ...HEADERS, "Content-Type": "application/json" },
          body: JSON.stringify(newEntry),
        });
        console.log("ğŸ”„ SimulaÃ§Ã£o registrada no Supabase:", newEntry);
      } catch {
        console.warn("âš ï¸ Supabase bloqueou gravaÃ§Ã£o pÃºblica. Somente leitura ativa.");
      }
    }

    // ==============================
    // EXPORTAÃ‡ÃƒO CSV
    // ==============================
    document.getElementById("exportCSV").addEventListener("click", async () => {
      const res = await fetch(`${SUPABASE_URL}/tuning_logs?select=*`, { headers: HEADERS });
      const data = await res.json();
      const csv = ["id,avg_latency,merge_success_rate,timestamp"]
        .concat(data.map(d => `${d.id},${d.avg_latency},${d.merge_success_rate},${d.timestamp}`))
        .join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "kmh_tuning_logs.csv";
      link.click();
    });

    // ==============================
    // GRÃFICO
    // ==============================
    function drawChart(data) {
      const ctx = document.getElementById("latencyChart").getContext("2d");
      const timestamps = data.map(d => new Date(d.timestamp).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }));
      const latencies = data.map(d => d.avg_latency);

      new Chart(ctx, {
        type: "line",
        data: {
          labels: timestamps,
          datasets: [{
            label: "LatÃªncia (s)",
            data: latencies,
            borderColor: "rgb(75,192,192)",
            backgroundColor: "rgba(75,192,192,0.3)",
            tension: 0.3,
            fill: true,
          }],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    // ==============================
    // EVENTOS E INICIALIZAÃ‡ÃƒO
    // ==============================
    document.getElementById("refresh").addEventListener("click", () => loadMetrics(true));
    loadMetrics();
  </script>
</body>
</html>
